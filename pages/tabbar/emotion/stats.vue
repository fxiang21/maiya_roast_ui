<template>
  <view class="stats-container">
    <!-- Á©∫Áä∂ÊÄÅÊèêÁ§∫ -->
    <view v-if="showEmptyState" class="empty-state">
      <view class="empty-content">
        <!-- ÂõæÊ†áÂíå‰∏ªË¶ÅÊèêÁ§∫ÊñáÂ≠ó -->
        <view class="main-empty">
          <view class="empty-text">
            <text class="highlight">Â•Ω</text>‰∏é<text class="highlight">‰∏çÂ•Ω</text>Ôºå
            <text class="brand-text">ÈªëÊ¥ûÂêêÊßΩ</text>
          </view>
        </view>
        
        <!-- Ê∑ªÂä†ÈºìÂä±ÊÄßÁöÑÈöèÊú∫ÊèêÁ§∫ËØ≠ -->
        <view class="encouragement">
          <text class="tip">{{ randomTip }}</text>
        </view>
        
        <!-- Êìç‰ΩúÊåâÈíÆ -->
        <button class="goto-emotion-btn" @tap="navigateToEmotion">
          <text class="iconfont icon-edit"></text>
          ÂéªÂêêÊßΩ
        </button>
      </view>
    </view>

    <!-- ÂéüÊúâÂÜÖÂÆπÔºåÂè™Âú®ÊúâÊï∞ÊçÆÊó∂ÊòæÁ§∫ -->
    <block v-else>
      <!-- Âë®ÊúüÈÄâÊã©Âô® -->
      <view class="period-selector">
        <view 
          v-for="item in periods" 
          :key="item.value"
          class="period-item"
          :class="{ active: currentPeriod === item.value }"
          @tap="changePeriod(item.value)"
        >
          {{ item.label }}
        </view>
      </view>

      <block v-if="statsData">
        <!-- Êï∞ÊçÆÊ¶ÇËßàÊ†áÈ¢ò -->
        <text class="section-title">Êï∞ÊçÆÊ¶ÇËßà</text>
        
        <!-- Êï∞ÊçÆÊ¶ÇËßàÂç°Áâá -->
        <view class="stats-card">
          <view class="overview-stats">
            <view class="stat-item">
              <text class="stat-value">{{ getStatValue(statsData.statistics.complaint_length) }}</text>
              <text class="stat-label">ÂêêÊßΩÂ≠óÊï∞</text>
            </view>
            <view class="stat-item">
              <text class="stat-value">{{ getLikesCount }}</text>
              <text class="stat-label">ÁÇπËµûÊï∞</text>
            </view>
            <view class="stat-item">
              <text class="stat-value">{{ getCommentsCount }}</text>
              <text class="stat-label">ËØÑËÆ∫Êï∞</text>
            </view>
          </view>
          
          <!-- ÊÉÖÊÑüÊ∞îÊ≥°Âõæ -->
          <view class="chart-section">
            <view class="emotion-bubbles-wrapper">
              <view class="emotion-bubbles">
                <!-- Ë∞ÉËØï‰ø°ÊÅØ -->
                <view v-if="!dynamicBubbles.length" class="debug-info">
                  {{ debugInfo || 'Âä†ËΩΩ‰∏≠...' }}
                </view>
                
                <!-- Ê∞îÊ≥°ÂÆπÂô® -->
                <view v-else class="bubbles-container">
                  <view
                    v-for="(bubble, index) in dynamicBubbles"
                    :key="index"
                    class="bubble-item"
                    :style="{
                      width: bubble.size + 'rpx',
                      height: bubble.size + 'rpx',
                      left: (bubble.x - bubble.size/2) + 'rpx',
                      top: (bubble.y - bubble.size/2) + 'rpx',
                      background: getBubbleGradient(bubble.emotion),
                      'clip-path': bubble.shape
                    }"
                  >
                    <view class="bubble-content">
                      <text class="emotion-face" :style="{
                        color: getContrastColor(bubble.emotion),
                        textShadow: '0 2rpx 4rpx rgba(0, 0, 0, 0.3)'
                      }">
                        {{ getEmotionFace(bubble.emotion) }}
                      </text>
                      <text class="emotion-text" :style="{
                        color: getContrastColor(bubble.emotion),
                        backgroundColor: 'rgba(0, 0, 0, 0.15)',
                        padding: '4rpx 12rpx',
                        borderRadius: '20rpx'
                      }">
                        {{ bubble.emotion }}
                      </text>
                    </view>
                  </view>
                </view>
              </view>
            </view>
            
            <!-- Êñ∞Â¢ûÊèêÁ§∫ÊñáÊú¨ -->
            <view class="chart-tip" v-if="emotionTips && emotionTips.emotion">
              <text class="tip-icon">üí°</text>
              <text class="tip-text">{{ emotionTips.emotion }}</text>
            </view>
          </view>
        </view>

        <!-- ÂàÜÁ±ªÁªüËÆ°Ê†áÈ¢ò -->
        <text class="section-title">ÂêêÊßΩÂàÜÁ±ª</text>
        
        <!-- ÂàÜÁ±ªÁªüËÆ°Âõæ -->
        <view class="stats-card">
          <view class="chart-wrapper">
            <view class="chart-title">ÂàÜÁ±ªÁªüËÆ°</view>
            <view class="category-chart">
              <view v-for="(categoryData, category) in processedCategoryData" :key="category" class="category-item">
                <view class="category-bars">
                  <view 
                    v-if="categoryData.positive > 0"
                    class="emotion-bar positive" 
                    :style="{height: categoryData.positive_height + 'rpx'}" 
                  >
                    <text class="bar-value">{{categoryData.positive}}</text>
                  </view>
                  
                  <view 
                    v-if="categoryData.neutral > 0"
                    class="emotion-bar neutral" 
                    :style="{height: categoryData.neutral_height + 'rpx'}" 
                  >
                    <text class="bar-value">{{categoryData.neutral}}</text>
                  </view>
                  
                  <view 
                    v-if="categoryData.negative > 0"
                    class="emotion-bar negative" 
                    :style="{height: categoryData.negative_height + 'rpx'}" 
                  >
                    <text class="bar-value">{{categoryData.negative}}</text>
                  </view>
                </view>
                <view class="category-name">{{category}}</view>
              </view>
              <view v-if="!Object.keys(processedCategoryData).length" class="empty-chart">
                ÊöÇÊó†ÂàÜÁ±ªÊï∞ÊçÆ
              </view>
            </view>
            
            <!-- Ê∑ªÂä†Âõæ‰æã -->
            <view class="chart-legend">
              <view class="legend-item">
                <view class="legend-color positive"></view>
                <text class="legend-text">ÁßØÊûÅ</text>
              </view>
              <view class="legend-item">
                <view class="legend-color neutral"></view>
                <text class="legend-text">‰∏≠ÊÄß</text>
              </view>
              <view class="legend-item">
                <view class="legend-color negative"></view>
                <text class="legend-text">Ê∂àÊûÅ</text>
              </view>
            </view>
            
            <!-- ÂàÜÁ±ªÁªüËÆ°ÊèêÁ§∫ÊñáÊú¨ -->
            <view class="chart-tip" v-if="emotionTips && emotionTips.category">
              <text class="tip-icon">üí°</text>
              <text class="tip-text">{{ emotionTips.category }}</text>
            </view>
          </view>
        </view>

        <!-- ÂÖ≥ÈîÆËØçÊ†áÈ¢ò -->
        <text class="section-title">ÂêêÊßΩÂÖ≥ÈîÆËØç</text>
        
        <!-- ÂÖ≥ÈîÆËØç‰∫ëÂõæ -->
        <view class="stats-card">
          <view class="chart-wrapper">
            <view class="chart-title">ÂÖ≥ÈîÆËØç‰∫ë</view>
            <view class="keyword-cloud-container">
              <view v-if="!processedKeywords.length" class="empty-chart">
                ÊöÇÊó†ÂÖ≥ÈîÆËØçÊï∞ÊçÆ
              </view>
              <view v-else class="keyword-cloud">
                <view 
                  v-for="(keyword, index) in processedKeywords" 
                  :key="index"
                  class="keyword-tag"
                  :style="{
                    fontSize: keyword.size + 'rpx',
                    color: keyword.color,
                    left: keyword.x + 'rpx',
                    top: keyword.y + 'rpx',
                    transform: `rotate(${keyword.rotate}deg)`,
                    opacity: keyword.opacity
                  }"
                >
                  {{ keyword.word }}
                </view>
              </view>
            </view>
            
            <!-- ÂÖ≥ÈîÆËØçÊèêÁ§∫ÊñáÊú¨ -->
            <view class="chart-tip" v-if="emotionTips && emotionTips.target">
              <text class="tip-icon">üí°</text>
              <text class="tip-text">{{ emotionTips.target }}</text>
            </view>
          </view>
        </view>
      </block>

      <view class="loading-state" v-if="isLoading">
        <uni-load-more status="loading" />
      </view>
    </block>
  </view>
</template>

<script>
import { getEmotionStats, getPeriodEmotionStats, getEmotionTips } from '@/api/emotion.js'
import DynamicBubbleChart from '@/utils/DynamicBubbleChart'

export default {
  components: {
  },
  data() {
    return {
      periods: [
        { label: 'Âë®', value: 'weekly' },
        { label: 'Êúà', value: 'monthly' },
        { label: 'Âπ¥', value: 'yearly' }
      ],
      currentPeriod: 'weekly',
      timeSeriesOpts: {
        padding: [15, 15, 0, 15],
        legend: { show: false },
        xAxis: {
          disableGrid: true,
          fontColor: '#CCCCCC'
        },
        yAxis: {
          gridType: 'dash',
          gridColor: 'rgba(255, 255, 255, 0.1)',
          fontColor: '#CCCCCC',
          min: 0
        },
        extra: {
          line: {
            type: 'curve',
            width: 2,
            activeType: 'hollow'
          }
        }
      },
      categoryOpts: {
        padding: [15, 15, 0, 15],
        legend: { show: false },
        xAxis: {
          disableGrid: true,
          fontColor: '#CCCCCC'
        },
        yAxis: {
          gridType: 'dash',
          gridColor: 'rgba(255, 255, 255, 0.1)',
          fontColor: '#CCCCCC',
          min: 0
        },
        extra: {
          column: {
            width: 30,
            radius: 6
          }
        }
      },
      timeSeriesData: null,
      periodStatsData: null,
      isLoading: false,
      cWidth: 0,
      cHeight: 0,
      pixelRatio: 1,
      chartKey: 0, // Áî®‰∫éÂº∫Âà∂Âà∑Êñ∞ÂõæË°®
      containerWidth: 0,
      containerHeight: 0,
      dynamicBubbles: [],
      bubbleChart: null,
      animationTimer: null,
      lastUpdate: 0,
      debugInfo: 'Âä†ËΩΩ‰∏≠...',
      currentRequests: [],
      autoRefreshTimer: null,
      _initialized: false,
      _statValueCache: {}, // Ê∑ªÂä†ÁºìÂ≠òÂØπË±°
      _requestLock: false,
      _requestLockTimer: null,
      _initializingBubblePromise: null,
      processedKeywords: [],
      emotionTips: null,
      tipTaskId: null,
      tipRetryCount: 0,
      tipMaxRetries: 5,
      // Ê∑ªÂä†ÊèêÁ§∫‰ø°ÊÅØÊï∞ÁªÑ
      tips: [
        "ÂêêÊßΩË∂äÂ§öÔºåÁªüËÆ°Ë∂äÂáÜÁ°Æ",
        "ÊäíÂèëÊÉÖÊÑüÔºåÁúãËßÅËá™Â∑±",
        "ÊÉÖÁª™ÂèòÂåñÔºåÂ∞ΩÂú®ÊéåÊè°",
        "ËÆ∞ÂΩïÂøÉÊÉÖÔºåÂèëÁé∞ËßÑÂæã",
        "ËÆ©ÈªëÊ¥ûÂ∏Æ‰Ω†ÂàÜÊûêÊÉÖÁª™"
      ],
    }
  },

  created() {
    console.log('ÁªÑ‰ª∂created')
  },

  async mounted() {
    console.log('stats mounted');
    
    // Ê∑ªÂä†ÂèØËßÅÊÄßÊ£ÄÊµã
    this.$nextTick(() => {
      this.checkVisibility();
    });
    
    // Ê∑ªÂä†ÂÆöÊó∂Âà∑Êñ∞
    this.autoRefreshTimer = setInterval(() => {
      if (this.$parent?.currentTab === 'analysis' && !this.isLoading) {
        this.loadAllStats();
      }
    }, 300000); // 5ÂàÜÈíüËá™Âä®Âà∑Êñ∞
  },

  computed: {
    statsData() {
      return this.periodStatsData || null
    },

    // Ëé∑ÂèñÁÇπËµûÊï∞
    getLikesCount() {
      console.log("this.statsData",this.statsData)
      if (!this.statsData || !this.statsData.user_stats) return 0
      return this.statsData.user_stats.likes_count || 0
    },
    
    // Ëé∑ÂèñËØÑËÆ∫Êï∞
    getCommentsCount() {
      console.log('getCommentsCountË¢´Ë∞ÉÁî®')
      if (!this.statsData || !this.statsData.user_stats) return 0
      return this.statsData.user_stats.comments_count || 0
    },

    // Ëé∑ÂèñÁõÆÊ†áÁªüËÆ°Êï∞ÊçÆ
    getTargetStats() {
      console.log('getTargetStatsË¢´Ë∞ÉÁî®')
      if (!this.statsData || !this.statsData.statistics || !this.statsData.statistics.target) {
        return {}
      }
      return this.statsData.statistics.target
    },

    // ÈáçÂÜôÂàÜÁ±ªÊï∞ÊçÆÂ§ÑÁêÜËÆ°ÁÆóÂ±ûÊÄß
    processedCategoryData() {
      if (!this.statsData || !this.statsData.statistics || !this.statsData.statistics.category) {
        console.log('ÂàÜÁ±ªÊï∞ÊçÆ‰∏∫Á©∫');
        return {};
      }
      
      const categoryData = this.statsData.statistics.category;
      console.log('ÂéüÂßãÂàÜÁ±ªÊï∞ÊçÆ:', JSON.stringify(categoryData));
      
      const result = {};
      
      // Â§ÑÁêÜÊØè‰∏™ÂàÜÁ±ª
      Object.entries(categoryData).forEach(([category, emotions]) => {
        if (!result[category]) {
          result[category] = {
            positive: 0,
            neutral: 0,
            negative: 0,
            total: 0
          };
        }
        
        // Áõ¥Êé•‰ΩøÁî®positive/negative/neutralÈîÆ
        if (typeof emotions === 'object' && emotions !== null) {
          // Áõ¥Êé•Êò†Â∞ÑÊÉÖÁª™ÂàÜÁ±ª
          if ('positive' in emotions) {
            result[category].positive = emotions.positive || 0;
          }
          if ('negative' in emotions) {
            result[category].negative = emotions.negative || 0;
          }
          if ('neutral' in emotions) {
            result[category].neutral = emotions.neutral || 0;
          }
          
          // ËÆ°ÁÆóÊÄªÊï∞
          result[category].total = 
            result[category].positive + 
            result[category].negative + 
            result[category].neutral;
        } else {
          console.warn(`ÂàÜÁ±ª ${category} ÁöÑÊÉÖÁª™Êï∞ÊçÆÊ†ºÂºè‰∏çÊ≠£Á°Æ:`, emotions);
        }
      });
      
      console.log('Â§ÑÁêÜÂêéÁöÑÂàÜÁ±ªÊï∞ÊçÆ:', JSON.stringify(result));
      
      // ÂØªÊâæÊúÄÂ§ßÂÄºÁî®‰∫éÁº©Êîæ
      let maxValue = 1;
      Object.values(result).forEach(item => {
        maxValue = Math.max(maxValue, item.positive, item.neutral, item.negative);
      });
      console.log('ÊúÄÂ§ßÂÄº:', maxValue);
      
      // ÈáçÊñ∞Ë∞ÉÊï¥ÊØî‰æã - ÈôêÂà∂ÊúÄÂ§ßÈ´òÂ∫¶
      const maxHeight = 160; // Èôç‰ΩéÊúÄÂ§ßÈ´òÂ∫¶(rpx)ÔºåÈò≤Ê≠¢Ë¶ÜÁõñ
      const minHeight = 20;  // ÊúÄÂ∞èÈ´òÂ∫¶(rpx)
      
      Object.values(result).forEach(item => {
        // Á°Æ‰øùÊúâÂÄºÁöÑÊü±Áä∂ÂõæËá≥Â∞ëÊúâÊúÄÂ∞èÈ´òÂ∫¶Ôºå‰ΩÜ‰∏çË∂ÖËøáÊúÄÂ§ßÈ´òÂ∫¶
        item.positive_height = item.positive > 0 ? 
          Math.max(minHeight, Math.min(maxHeight, Math.floor(item.positive / maxValue * maxHeight))) : 0;
        
        item.neutral_height = item.neutral > 0 ? 
          Math.max(minHeight, Math.min(maxHeight, Math.floor(item.neutral / maxValue * maxHeight))) : 0;
        
        item.negative_height = item.negative > 0 ? 
          Math.max(minHeight, Math.min(maxHeight, Math.floor(item.negative / maxValue * maxHeight))) : 0;
      });
      
      console.log('ÊúÄÁªàÊ∏≤ÊüìÊï∞ÊçÆ:', JSON.stringify(result));
      return result;
    },
    
    // ‰ºòÂåñÂÖ≥ÈîÆËØçÁõ∏ÂÖ≥ËÆ°ÁÆóÂ±ûÊÄß
    keywordMaxCount() {
      if (!this.getTargetStats || Object.keys(this.getTargetStats).length === 0) {
        return 1;
      }
      return Math.max(...Object.values(this.getTargetStats));
    },
    
    // ËÆ°ÁÆóÂÖ≥ÈîÆËØçÊÄªÊï∞ÔºåÁî®‰∫éË∞ÉÊï¥ÊòæÁ§∫ÊïàÊûú
    keywordTotalCount() {
      if (!this.getTargetStats) return 0;
      return Object.values(this.getTargetStats).reduce((sum, count) => sum + count, 0);
    },

    // Ê∑ªÂä†Á©∫Áä∂ÊÄÅÂà§Êñ≠
    showEmptyState() {
      // Âà§Êñ≠ÊòØÂê¶ÊúâÁªüËÆ°Êï∞ÊçÆ‰∏îÊï∞ÊçÆ‰∏∫Á©∫
      return !this.isLoading && 
             (!this.statsData || 
              !this.statsData.statistics || 
              (this.statsData.statistics && 
               Object.keys(this.statsData.statistics).length === 0));
    },
    
    // ÈöèÊú∫ÊèêÁ§∫ËØ≠
    randomTip() {
      return this.tips[Math.floor(Math.random() * this.tips.length)];
    },
  },

  methods: {
    // ‰ºòÂåñ getStatValue ÊñπÊ≥ïÔºåÊ∑ªÂä†ÁºìÂ≠ò
    getStatValue(value) {
      // ‰ΩøÁî®ÁÆÄÂçïÁöÑÁºìÂ≠òÊú∫Âà∂
      const cacheKey = `stat_${value}`;
      if (this._statValueCache[cacheKey] !== undefined) {
        return this._statValueCache[cacheKey];
      }
      
      // Âè™Âú®Ë∞ÉËØïÊ®°Âºè‰∏ãÊâìÂç∞Êó•Âøó
      if (process.env.NODE_ENV === 'development') {
        console.log('getStatValueË¢´Ë∞ÉÁî®', value);
      }
      
      const result = value || 0;
      this._statValueCache[cacheKey] = result;
      return result;
    },
    
    // Âú®Êï∞ÊçÆÊõ¥Êñ∞Êó∂Ê∏ÖÈô§ÁºìÂ≠ò
    clearStatValueCache() {
      this._statValueCache = {};
    },

    // Ëé∑ÂèñÊ∞îÊ≥°ÁöÑ‰∏çËßÑÂàôÂúÜÂΩ¢ÊïàÊûú
    getBubbleRadius(size) {
      const radius1 = size * 0.5;
      const radius2 = size * 0.48;
      const radius3 = size * 0.52;
      const radius4 = size * 0.49;
      return `${radius1}% ${radius2}% ${radius3}% ${radius4}%`;
    },

    // Ëé∑ÂèñË°®ÊÉÖÈ¢úËâ≤
    getEmotionFaceColor(emotion) {
      const colors = {
        // ÁßØÊûÅÊÉÖÁª™ - ÊöñËâ≤Ë∞É
        'Âø´‰πê': '#FFD700',  // ÈáëËâ≤
        'ÊúüÂæÖ': '#FFA500',  // Ê©ôËâ≤
        '‰ø°‰ªª': '#98FB98',  // ÊµÖÁªøËâ≤
        'Áà±': '#FF69B4',    // Á≤âÁ∫¢Ëâ≤
        'È™ÑÂÇ≤': '#DDA0DD',  // Ê¢ÖÁ∫¢Ëâ≤
        'Â∏åÊúõ': '#90EE90',  // Ê∑°ÁªøËâ≤
        'ÂÖ¥Â•ã': '#FFA07A',  // ÊµÖÈ≤ëÈ±ºËâ≤
        'Êª°Ë∂≥': '#FFB6C1',  // ÊµÖÁ≤âËâ≤
        
        // ‰∏≠ÊÄßÊÉÖÁª™ - ÊüîÂíåËâ≤Ë∞É
        'ÊÉäËÆ∂': '#87CEEB',  // Â§©ËìùËâ≤
        'Âπ≥Èùô': '#E0FFFF',  // Ê∑°ÈùíËâ≤
        'Â•ΩÂ•á': '#B0E0E6',  // Á≤âËìùËâ≤
        'Ê∑°ÂÆö': '#F0F8FF',  // Áà±‰∏Ω‰∏ùËìù
        'Âõ∞ÊÉë': '#E6E6FA',  // Ê∑°Á¥´Ëâ≤
        
        // Ê∂àÊûÅÊÉÖÁª™ - ÂÜ∑Ëâ≤Ë∞É
        'ÊÇ≤‰º§': '#B0C4DE',  // ÊµÖÈí¢Ëìù
        'ÊÑ§ÊÄí': '#FF6B6B',  // ÊµÖÁ∫¢Ëâ≤
        'ÊÅêÊÉß': '#A9A9A9',  // Ê∑±ÁÅ∞Ëâ≤
        'ÂéåÊÅ∂': '#DDA0DD',  // Ê¢ÖÁ∫¢Ëâ≤
        'ÁÑ¶Ëôë': '#D3D3D3',  // ÊµÖÁÅ∞Ëâ≤
        'Â§±Êúõ': '#C0C0C0',  // Èì∂Ëâ≤
        'Â´âÂ¶í': '#DA70D6',  // ÂÖ∞Ëä±Á¥´
        'ÁæûÊÑß': '#FFB6C1',  // ÊµÖÁ≤âÁ∫¢
        'ÂÜÖÁñö': '#B0C4DE',  // ÊµÖÈí¢Ëìù
        'Â≠§Áã¨': '#A9A9A9'   // Ê∑±ÁÅ∞Ëâ≤
      }
      return colors[emotion] || '#FFFFFF'
    },

    // Ëé∑ÂèñÊ∞îÊ≥°Ê∏êÂèòËÉåÊôØ
    getBubbleGradient(emotion) {
      const gradients = {
        // ÁßØÊûÅÊÉÖÁª™ - ÊöñËâ≤Ë∞ÉÊ∏êÂèò
        'Âø´‰πê': 'radial-gradient(circle at 30% 30%, rgba(255, 228, 214, 0.95), rgba(255, 196, 176, 0.85))',
        'ÊúüÂæÖ': 'radial-gradient(circle at 30% 30%, rgba(255, 232, 214, 0.95), rgba(255, 212, 176, 0.85))',
        '‰ø°‰ªª': 'radial-gradient(circle at 30% 30%, rgba(200, 255, 200, 0.95), rgba(170, 255, 170, 0.85))',
        'Áà±': 'radial-gradient(circle at 30% 30%, rgba(255, 214, 244, 0.95), rgba(255, 176, 224, 0.85))',
        'È™ÑÂÇ≤': 'radial-gradient(circle at 30% 30%, rgba(255, 214, 244, 0.95), rgba(255, 176, 224, 0.85))',
        'Â∏åÊúõ': 'radial-gradient(circle at 30% 30%, rgba(200, 255, 200, 0.95), rgba(170, 255, 170, 0.85))',
        'ÂÖ¥Â•ã': 'radial-gradient(circle at 30% 30%, rgba(255, 214, 214, 0.95), rgba(255, 176, 176, 0.85))',
        'Êª°Ë∂≥': 'radial-gradient(circle at 30% 30%, rgba(255, 228, 228, 0.95), rgba(255, 196, 196, 0.85))',
        
        // ‰∏≠ÊÄßÊÉÖÁª™ - Ê∑°Ëâ≤Ë∞ÉÊ∏êÂèò
        'ÊÉäËÆ∂': 'radial-gradient(circle at 30% 30%, rgba(186, 225, 255, 0.95), rgba(143, 198, 255, 0.85))',
        'Âπ≥Èùô': 'radial-gradient(circle at 30% 30%, rgba(224, 255, 255, 0.95), rgba(196, 255, 255, 0.85))',
        'Â•ΩÂ•á': 'radial-gradient(circle at 30% 30%, rgba(176, 224, 230, 0.95), rgba(143, 198, 208, 0.85))',
        'Ê∑°ÂÆö': 'radial-gradient(circle at 30% 30%, rgba(240, 248, 255, 0.95), rgba(220, 230, 240, 0.85))',
        'Âõ∞ÊÉë': 'radial-gradient(circle at 30% 30%, rgba(230, 230, 250, 0.95), rgba(210, 210, 230, 0.85))',
        
        // Ê∂àÊûÅÊÉÖÁª™ - ÂÜ∑Ëâ≤Ë∞ÉÊ∏êÂèò
        'ÊÇ≤‰º§': 'radial-gradient(circle at 30% 30%, rgba(232, 241, 255, 0.95), rgba(210, 219, 255, 0.85))',
        'ÊÑ§ÊÄí': 'radial-gradient(circle at 30% 30%, rgba(255, 200, 200, 0.95), rgba(255, 162, 162, 0.85))',
        'ÊÅêÊÉß': 'radial-gradient(circle at 30% 30%, rgba(200, 200, 200, 0.95), rgba(180, 180, 180, 0.85))',
        'ÂéåÊÅ∂': 'radial-gradient(circle at 30% 30%, rgba(255, 200, 255, 0.95), rgba(255, 170, 255, 0.85))',
        'ÁÑ¶Ëôë': 'radial-gradient(circle at 30% 30%, rgba(211, 211, 211, 0.95), rgba(190, 190, 190, 0.85))',
        'Â§±Êúõ': 'radial-gradient(circle at 30% 30%, rgba(192, 192, 192, 0.95), rgba(170, 170, 170, 0.85))',
        'Â´âÂ¶í': 'radial-gradient(circle at 30% 30%, rgba(218, 112, 214, 0.95), rgba(198, 92, 194, 0.85))',
        'ÁæûÊÑß': 'radial-gradient(circle at 30% 30%, rgba(255, 182, 193, 0.95), rgba(255, 162, 173, 0.85))',
        'ÂÜÖÁñö': 'radial-gradient(circle at 30% 30%, rgba(176, 196, 222, 0.95), rgba(156, 176, 202, 0.85))',
        'Â≠§Áã¨': 'radial-gradient(circle at 30% 30%, rgba(169, 169, 169, 0.95), rgba(149, 149, 149, 0.85))'
      }
      return gradients[emotion] || 'radial-gradient(circle at 30% 30%, rgba(200, 200, 200, 0.95), rgba(170, 170, 170, 0.85))'
    },

    // Ëé∑ÂèñÊÉÖÊÑüÂØπÂ∫îÁöÑË°®ÊÉÖÁ¨¶Âè∑
    getEmotionFace(emotion) {
      const faces = {
        // ÁßØÊûÅÊÉÖÁª™
        'Âø´‰πê': 'ÀÉ·¥óÀÇ',
        'ÊúüÂæÖ': '‚úß ‚úß',
        '‰ø°‰ªª': 'À∂‚öà ·¥ó ‚öàÀµ',
        'Áà±': '‚ô° ‚ô°',
        'È™ÑÂÇ≤': '‚å¢Ãà ‚å¢Ãà',
        'Â∏åÊúõ': 'À∂‚öà ·¥ó ‚öàÀµ',
        'ÂÖ¥Â•ã': '‚úß ‚úß',
        'Êª°Ë∂≥': '‚å£Ãà ‚å£Ãà',
        
        // ‰∏≠ÊÄßÊÉÖÁª™
        'ÊÉäËÆ∂': '‚óé ‚óé',
        'Âπ≥Èùô': '‚å£Ãà ‚å£Ãà',
        'Â•ΩÂ•á': '‚Ä¢ ‚Ä¢',
        'Ê∑°ÂÆö': '‚å£Ãà ‚å£Ãà',
        'Âõ∞ÊÉë': '? ?',
        
        // Ê∂àÊûÅÊÉÖÁª™
        'ÊÇ≤‰º§': 'Ôπè',
        'ÊÑ§ÊÄí': '‚ãã_‚ãå',
        'ÊÅêÊÉß': 'Ôπè',
        'ÂéåÊÅ∂': 'Ô∏ø',
        'ÁÑ¶Ëôë': '‚äôÔπè‚äô',
        'Â§±Êúõ': 'Ô∏∂',
        'Â´âÂ¶í': '‚ãã_‚ãå',
        'ÁæûÊÑß': '‚ÅÑ‚ÅÑ‚Ä¢‚ÅÑœâ‚ÅÑ‚Ä¢‚ÅÑ‚ÅÑ',
        'ÂÜÖÁñö': 'Ôπè',
        'Â≠§Áã¨': 'Ô∏∂'
      }
      return faces[emotion] || '‚å£Ãà' // ÈªòËÆ§Ë°®ÊÉÖ
    },

    // Ëé∑ÂèñÊ∞îÊ≥°Â§ßÂ∞è
    getBubbleSize(value) {
      // Âü∫Á°ÄÂ§ßÂ∞è‰∏∫120rpxÔºåÊúÄÂ§ß‰∏∫300rpx
      const baseSize = 120
      const maxSize = 300
      // Ê†πÊçÆÊÉÖÊÑüÂÄºÁöÑÁôæÂàÜÊØîËÆ°ÁÆóÂ§ßÂ∞è
      const size = baseSize + (value / 100) * (maxSize - baseSize)
      return Math.min(maxSize, Math.max(baseSize, size))
    },

    // ‰øÆÊîπÂêéÁöÑÂë®ÊúüÂàáÊç¢ÊñπÊ≥ï
    async changePeriod(period) {
      if (this.currentPeriod === period) return;
      
      // ‰∏≠Ê≠¢ÊâÄÊúâËøõË°å‰∏≠ÁöÑËØ∑Ê±Ç
      this.abortAllRequests();
      this.stopAnimation();

      this.currentPeriod = period;
      this.loadAllStats();
    },

    abortAllRequests() {
      this.currentRequests.forEach(task => {
        if (task && typeof task.abort === 'function') {
          task.abort();
        }
      });
      this.currentRequests = [];
    },

    // ‰ºòÂåñ initAnalysis ÊñπÊ≥ïÔºåÁ°Æ‰øùÁªÑ‰ª∂ÂèØËßÅÊó∂Á´ãÂç≥Âä†ËΩΩÊï∞ÊçÆ
    initAnalysis() {
      console.log('Áªü‰∏ÄÂàùÂßãÂåñÂàÜÊûêÈ°µÈù¢');
      
      // Êó†ËÆ∫ÊòØÂê¶Â∑≤ÂàùÂßãÂåñÔºåÈÉΩÂ∞ùËØïÂä†ËΩΩÊï∞ÊçÆ
      // ÈÅøÂÖçÈáçÂ§çÂàùÂßãÂåñÂõæË°®
      const shouldInitBubbles = !this.bubbleChart;
      
      // Ê†áËÆ∞‰∏∫Â∑≤ÂàùÂßãÂåñ
      this._initialized = true;
      
      // ‰ΩøÁî® nextTick Á°Æ‰øù DOM Â∑≤Ê∏≤Êüì
      this.$nextTick(async () => {
        try {
          // ÂÖàÂàùÂßãÂåñÂõæË°®ÂÆπÂô®ÔºàÂ¶ÇÊûúÈúÄË¶ÅÔºâ
          if (shouldInitBubbles) {
            await this.initDynamicBubbles(true);
          }
          
          // ‰ΩøÁî®ËØ∑Ê±ÇÈîÅÂÆöÊú∫Âà∂Âä†ËΩΩÊï∞ÊçÆ
          this.loadAllStatsWithLock();
          
          console.log('ÂàÜÊûêÈ°µÈù¢ÂàùÂßãÂåñÂÆåÊàê');
        } catch (error) {
          console.error('ÂàùÂßãÂåñÂàÜÊûêÈ°µÈù¢Â§±Ë¥•:', error);
          this.debugInfo = 'ÂàùÂßãÂåñÂ§±Ë¥•ÔºåËØ∑ÈáçËØï';
        }
      });
    },

    // Ê∑ªÂä†Â∏¶ÈîÅÂÆöÊú∫Âà∂ÁöÑÊï∞ÊçÆÂä†ËΩΩÊñπÊ≥ï
    loadAllStatsWithLock() {
      // Â¶ÇÊûúÈîÅÂÆö‰∏≠ÔºåË∑≥ËøáËØ∑Ê±Ç
      if (this._requestLock) {
        console.log('ËØ∑Ê±ÇÂ∑≤ÈîÅÂÆöÔºåË∑≥ËøáÈáçÂ§çËØ∑Ê±Ç');
        return;
      }
      
      // ËÆæÁΩÆÈîÅÂÆö
      this._requestLock = true;
      
      // Ê∏ÖÈô§‰πãÂâçÁöÑÂÆöÊó∂Âô®
      if (this._requestLockTimer) {
        clearTimeout(this._requestLockTimer);
      }
      
      // ÊâßË°åÊï∞ÊçÆÂä†ËΩΩ
      this.loadAllStats();
      
      // ËÆæÁΩÆÈîÅÂÆöÈáäÊîæÂÆöÊó∂Âô®Ôºà1ÁßíÂêéÈáäÊîæÈîÅÂÆöÔºâ
      this._requestLockTimer = setTimeout(() => {
        this._requestLock = false;
      }, 1000);
    },

    // ‰øÆÊîπ onShow ÁîüÂëΩÂë®ÊúüÈí©Â≠ê
    onShow() {
      console.log('stats onShow');
      if (this._initialized && this.$parent?.currentTab === 'analysis' && !this.periodStatsData) {
        // Âè™Âú®Ê≤°ÊúâÊï∞ÊçÆÊó∂ÊâçÂä†ËΩΩ
        this.loadAllStatsWithLock();
      }
    },

    // ÊîπËøõ initDynamicBubbles ÊñπÊ≥ïÔºåÂ¢ûÂº∫Á®≥ÂÆöÊÄßÂíåÂèØÈù†ÊÄß
    initDynamicBubbles(forceReset = false) {
      // Ê∑ªÂä†Èò≤ÈáçÂ§çÂàùÂßãÂåñÈÄªËæë
      if (this.bubbleChart && !forceReset) {
        console.log('Ê∞îÊ≥°ÂõæÂ∑≤ÂàùÂßãÂåñÔºåË∑≥Ëøá')
        return Promise.resolve(this.bubbleChart)
      }
      
      // Â¶ÇÊûúÊ≠£Âú®ÂàùÂßãÂåñ‰∏≠ÔºåËøîÂõûÁé∞ÊúâÁöÑpromise
      if (this._initializingBubblePromise && !forceReset) {
        console.log('Ê∞îÊ≥°ÂõæÊ≠£Âú®ÂàùÂßãÂåñ‰∏≠ÔºåËøîÂõûÁé∞Êúâpromise')
        return this._initializingBubblePromise
      }
      
      console.log('initDynamicBubblesË¢´Ë∞ÉÁî®')
      
      // ÂàõÂª∫ÂàùÂßãÂåñPromiseÂπ∂‰øùÂ≠òÂºïÁî®
      this._initializingBubblePromise = new Promise((resolve, reject) => {
        const attemptInit = (retryCount = 0) => {
          if (retryCount > 5) {
            console.error('Ê∞îÊ≥°ÂõæÂàùÂßãÂåñÂ§±Ë¥•ÔºåË∂ÖËøáÊúÄÂ§ßÈáçËØïÊ¨°Êï∞')
            reject(new Error('ÂàùÂßãÂåñÂ§±Ë¥•ÔºåË∂ÖËøáÊúÄÂ§ßÈáçËØïÊ¨°Êï∞'))
            this._initializingBubblePromise = null
            return
          }
          
          // Á°Æ‰øùÂú®DOMÊ∏≤ÊüìÂÆåÊàêÂêéÊâßË°å
          this.$nextTick(() => {
            const query = uni.createSelectorQuery().in(this)
            query.select('.emotion-bubbles-wrapper')
              .boundingClientRect(data => {
                if (data && data.width && data.height && data.width > 0 && data.height > 0) {
                  // ËøôÈáå data.width Âíå data.height ‰∏∫ px Âçï‰Ωç
                  try {
                    uni.getSystemInfo({
                      success: (res) => {
                        const designWidth = 750;
                        const scaleFactor = designWidth / res.windowWidth;
                        // ËΩ¨Êç¢Êàê rpx ÂêéÁöÑÂ∞∫ÂØ∏
                        this.containerWidth = data.width * scaleFactor;
                        this.containerHeight = data.height * scaleFactor;
            
                        // ÂàùÂßãÂåñÊ∞îÊ≥°ÂõæÊó∂‰º†ÂÖ• scaleFactor
                        this.bubbleChart = new DynamicBubbleChart({
                          width: this.containerWidth,
                          height: this.containerHeight,
                          minSize: 60,
                          maxSize: 180,
                          maxSpeed: 1.2,
                          scaleFactor: 1 // Ê≠§Â§ÑÂú® DynamicBubbleChart ÈáåÂ∑≤Ë∞ÉÁî®ËΩ¨Êç¢ÔºåÊâÄ‰ª•‰º†ÂÖ•1Âç≥ÂèØ
                        });
            
                        console.log('Ê∞îÊ≥°ÂõæÂàùÂßãÂåñÊàêÂäüÔºåÂÆπÂô®Â∞∫ÂØ∏:', {
                          width: this.containerWidth,
                          height: this.containerHeight
                        });
                        
                        // Ê∏ÖÈô§ÂàùÂßãÂåñPromiseÂºïÁî®
                        this._initializingBubblePromise = null
                        
                        // Â¶ÇÊûúÊúâÊï∞ÊçÆÔºåÁ´ãÂç≥Êõ¥Êñ∞Ê∞îÊ≥°
                        if (this.periodStatsData?.statistics?.emotion) {
                          this.updateBubbles();
                        }
                        
                        resolve(this.bubbleChart);
                      },
                      fail: (err) => {
                        console.error('Ëé∑ÂèñÁ≥ªÁªü‰ø°ÊÅØÂ§±Ë¥•:', err);
                        // Ê∏ÖÈô§ÂàùÂßãÂåñPromiseÂºïÁî®
                        this._initializingBubblePromise = null
                        reject(err);
                      }
                    });
                  } catch (error) {
                    console.error('ÂàùÂßãÂåñÊ∞îÊ≥°ÂõæÂá∫Èîô:', error);
                    this._initializingBubblePromise = null
                    reject(error);
                  }
                } else {
                  console.warn(`Êú™ÊâæÂà∞ÂÆπÂô®ÂÖÉÁ¥†ÊàñÂÆπÂô®Â∞∫ÂØ∏‰∏∫0 (Â∞ùËØï ${retryCount+1}/6):`, data);
                  // Âª∂ËøüÈáçËØïÔºåÊØèÊ¨°Â¢ûÂä†Âª∂ËøüÊó∂Èó¥
                  setTimeout(() => {
                    attemptInit(retryCount + 1);
                  }, 300 * (retryCount + 1));
                }
              }).exec();
          });
        };
        
        // ÂºÄÂßãÂàùÂßãÂåñÂ∞ùËØï
        attemptInit();
      });
      
      return this._initializingBubblePromise;
    },

    // ÊîπËøõupdateBubblesÊñπÊ≥ïÔºåÂ¢ûÂä†Êõ¥Â§öÊ£ÄÊü•
    updateBubbles() {
      if (!this.bubbleChart) {
        console.warn('Êó†Ê≥ïÊõ¥Êñ∞Ê∞îÊ≥°: ÂõæË°®Êú™ÂàùÂßãÂåñ');
        // Â∞ùËØïÂàùÂßãÂåñÂõæË°®
        this.initDynamicBubbles(true).then(() => {
          this.updateBubbles();
        });
        return;
      }
      
      if (!this.periodStatsData || !this.periodStatsData.statistics || !this.periodStatsData.statistics.emotion) {
        console.warn('Êó†Ê≥ïÊõ¥Êñ∞Ê∞îÊ≥°: Êó†Êï∞ÊçÆÊàñÊï∞ÊçÆÊ†ºÂºè‰∏çÊ≠£Á°Æ', this.periodStatsData);
        return;
      }
      
      console.log('Êõ¥Êñ∞Ê∞îÊ≥°ÔºåÊï∞ÊçÆ:', this.periodStatsData.statistics.emotion);
      try {
        this.dynamicBubbles = this.bubbleChart.generateBubbles(this.periodStatsData.statistics.emotion);
        // Êõ¥Êñ∞ÂêéÁ´ãÂç≥ÂºÄÂßãÂä®Áîª
        this.startAnimation();
      } catch (error) {
        console.error('ÁîüÊàêÊ∞îÊ≥°Êó∂Âá∫Èîô:', error);
      }
    },

    startAnimation() {
      if (this.animationTimer) {
        clearTimeout(this.animationTimer)
        this.animationTimer = null
      }

      let isStable = false
      const stabilityThreshold = 0.1
      const maxStableFrames = 60
      let stableFrameCount = 0

      const checkStability = () => {
        const movingBubbles = this.dynamicBubbles.filter(b => 
          Math.abs(b.vx) > stabilityThreshold || 
          Math.abs(b.vy) > stabilityThreshold
        )
        return movingBubbles.length === 0
      }

      const animate = () => {
        if (!this.bubbleChart || isStable) return

        const now = Date.now()
        if (!this.lastUpdate) this.lastUpdate = now
        const deltaTime = now - this.lastUpdate
        
        if (deltaTime > 16) {
          try {
            this.bubbleChart.updatePositions()
            
            // Ê∑ªÂä†ÈÄüÂ∫¶Ë°∞Âáè
            this.dynamicBubbles.forEach(b => {
              b.vx *= 0.98
              b.vy *= 0.98
            })

            // Êõ¥Êñ∞ËßÜÂõæ
            this.$set(this, 'dynamicBubbles', [...this.bubbleChart.bubbles])
            this.lastUpdate = now

            // Á®≥ÂÆöÊÄßÊ£ÄÊµã
            if (checkStability()) {
              stableFrameCount++
              if (stableFrameCount >= maxStableFrames) {
                isStable = true
                console.log('Âä®ÁîªÂ∑≤Á®≥ÂÆöÔºåÂÅúÊ≠¢Êõ¥Êñ∞')
                return
              }
            } else {
              stableFrameCount = 0
            }
          } catch (e) {
            console.error('Âä®ÁîªÊõ¥Êñ∞ÂºÇÂ∏∏Ôºö', e)
            this.stopAnimation()
            return
          }
        }
        
        // ÊîπÁî® setTimeout ÂÖºÂÆπÂ∞èÁ®ãÂ∫èÁéØÂ¢É
        this.animationTimer = setTimeout(animate, 16)
      }
      
      animate()
    },

    stopAnimation() {
      if (this.animationTimer) {
        clearTimeout(this.animationTimer)
        this.animationTimer = null
      }
    },

    onChartComplete() {
      console.log('ÂõæË°®Ê∏≤ÊüìÂÆåÊàê')
    },

    // Êñ∞Â¢ûÈ¢úËâ≤ËÆ°ÁÆóÊñπÊ≥ï
    getContrastColor(emotion) {
      const gradient = this.getBubbleGradient(emotion);
      // ‰ªéÊ∏êÂèò‰∏≠ÊèêÂèñ‰∏ªËâ≤
      const mainColor = gradient.match(/rgba?\([^)]+\)/)?.[0] || '#FFFFFF';
      // ËÆ°ÁÆó‰∫ÆÂ∫¶ÂÄº
      const rgb = mainColor.match(/\d+/g);
      const brightness = (rgb[0] * 299 + rgb[1] * 587 + rgb[2] * 114) / 1000;
      return brightness > 150 ? 'rgba(0, 0, 0, 0.8)' : 'rgba(255, 255, 255, 0.9)';
    },

    // Ê∑ªÂä† loadStats ÊñπÊ≥ï
    loadStats() {
      console.log('loadStatsË¢´Ë∞ÉÁî®')
      // ÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
      this.initDynamicBubbles()
      // Â¶ÇÊûúÊúâÂÖ∂‰ªñÊï∞ÊçÆÂä†ËΩΩÈÄªËæëÔºå‰πüÊîæÂú®ËøôÈáå
    },

    // ‰øÆÊîπ loadAllStats ÊñπÊ≥ïÔºåÁ°Æ‰øùÊï∞ÊçÆÂä†ËΩΩÂíåÊ∞îÊ≥°Êõ¥Êñ∞ÁöÑÊ≠£Á°ÆÈ°∫Â∫è
    async loadAllStats() {
      // Â¶ÇÊûúÂ∑≤ÁªèÂú®Âä†ËΩΩ‰∏≠ÔºåÂàôË∑≥Ëøá
      if (this.isLoading) {
        console.log('Êï∞ÊçÆÊ≠£Âú®Âä†ËΩΩ‰∏≠ÔºåË∑≥ËøáÈáçÂ§çËØ∑Ê±Ç');
        return;
      }
      
      this.isLoading = true;
      this.debugInfo = 'Âä†ËΩΩ‰∏≠...';
      
      try {
        this.abortAllRequests(); // Ê∏ÖÈô§ÊóßËØ∑Ê±Ç
        this.clearStatValueCache(); // Ê∏ÖÈô§ÁºìÂ≠ò
        
        // ‰ΩøÁî® Promise.all Âπ∂ÂèëËØ∑Ê±ÇÊï∞ÊçÆ
        const [periodStatsRes] = await Promise.all([
          //this.fetchEmotionStats(this.currentPeriod),
          this.fetchPeriodStats(this.currentPeriod)
        ]);
        
        
        // Ê£ÄÊü•Êï∞ÊçÆÊúâÊïàÊÄß
        if (!periodStatsRes.data || !periodStatsRes.data.statistics) {
          console.warn('Âä†ËΩΩÁöÑÊï∞ÊçÆÊ†ºÂºè‰∏çÊ≠£Á°Æ:', periodStatsRes);
          this.debugInfo = 'Êï∞ÊçÆÊ†ºÂºè‰∏çÊ≠£Á°ÆÔºåËØ∑ÈáçËØï';
          this.isLoading = false;
          return;
        }
        
        // ÂÖàÊõ¥Êñ∞Êï∞ÊçÆ
        this.periodStatsData = periodStatsRes.data;
        this.chartKey++; // Âº∫Âà∂Âà∑Êñ∞ÂõæË°®
        
        // Á°Æ‰øùÊ∞îÊ≥°ÂõæÂ∑≤ÂàùÂßãÂåñÔºåÁÑ∂ÂêéÊõ¥Êñ∞Ê∞îÊ≥°
        try {
          // Â¶ÇÊûúÊ∞îÊ≥°ÂõæÊú™ÂàùÂßãÂåñÔºåÂÖàÂàùÂßãÂåñ
          if (!this.bubbleChart) {
            await this.initDynamicBubbles(true);
          }
          
          // Êõ¥Êñ∞Ê∞îÊ≥°
          this.updateBubbles();
        } catch (error) {
          console.error('Êõ¥Êñ∞Ê∞îÊ≥°Â§±Ë¥•:', error);
        }
        
        // Âú®Êï∞ÊçÆÊõ¥Êñ∞ÂêéÂà∑Êñ∞ËØç‰∫ëÂ∏ÉÂ±Ä
        this.$nextTick(() => {
          this.layoutKeywords();
        });
        
        // ÊúÄÂêéÊ∏ÖÈô§Âä†ËΩΩÁä∂ÊÄÅ
        this.isLoading = false;
        this.debugInfo = '';
      } catch (error) {
        console.error('Âä†ËΩΩÁªüËÆ°Êï∞ÊçÆÂ§±Ë¥•:', error);
        this.isLoading = false;
        this.debugInfo = 'Âä†ËΩΩÂ§±Ë¥•ÔºåËØ∑ÈáçËØï';
      }
    },

    fetchEmotionStats(period) {
      return new Promise((resolve, reject) => {
        const requestTask = getEmotionStats(
          period,
          (res) => {
            this.currentRequests = this.currentRequests.filter(t => t !== requestTask);
            resolve(res);
          },
          (err) => {
            this.currentRequests = this.currentRequests.filter(t => t !== requestTask);
            reject(err);
          }
        );
        this.currentRequests.push(requestTask);
      });
    },

    fetchPeriodStats(period) {
      return new Promise((resolve, reject) => {
        const requestTask = getPeriodEmotionStats(
          period,
          (res) => {
            this.currentRequests = this.currentRequests.filter(t => t !== requestTask);
            
            // Â¶ÇÊûúËøîÂõû‰∫Ütask_idÔºåÂàôËé∑ÂèñÊÉÖÊÑüÂª∫ËÆÆ
            if (res.data && res.data.task_id) {
              this.tipTaskId = res.data.task_id;
              this.tipRetryCount = 0;
              this.fetchEmotionTips();
            }
            
            resolve(res);
          },
          (err) => {
            this.currentRequests = this.currentRequests.filter(t => t !== requestTask);
            reject(err);
          }
        );
        this.currentRequests.push(requestTask);
      });
    },

    initSize() {
      console.log('initSizeË¢´Ë∞ÉÁî®')
      uni.getSystemInfo({
        success: (res) => {
          this.cWidth = res.windowWidth - 40 // ËÄÉËôëpadding
          this.cHeight = 300
          this.pixelRatio = res.pixelRatio
        }
      })
    },

    // Êõ¥Êñ∞ÂõæË°®
    updateCharts() {
      this.chartKey += 1;
    },

    onComplete(e) {
      console.log('ÂõæË°®Ê∏≤ÊüìÂÆåÊàêÔºö', e)
    },
    
    onError(e) {
      console.error('ÂõæË°®Ê∏≤ÊüìÈîôËØØÔºö', e)
    },
    
    touchChart(e) {
      console.log('ÂõæË°®Ëß¶Êë∏‰∫ã‰ª∂Ôºö', e)
    },

    // Â∏ÉÂ±ÄËØç‰∫ë
    layoutKeywords() {
      // ÂÖàÊ∏ÖÁ©∫Êï∞ÁªÑ
      this.processedKeywords = [];
      
      if (!this.getTargetStats || Object.keys(this.getTargetStats).length === 0) {
        return;
      }
      
      // Ëé∑ÂèñÂÆπÂô®Â∞∫ÂØ∏
      const containerWidth = 690; // Êï¥‰∏™ÂÆπÂô®ÂÆΩÂ∫¶ÔºåÂçï‰Ωçrpx
      const containerHeight = 400; // Êï¥‰∏™ÂÆπÂô®È´òÂ∫¶ÔºåÂçï‰Ωçrpx
      const centerX = containerWidth / 2;
      const centerY = containerHeight / 2;
      
      // Â∞ÜÂØπË±°ËΩ¨‰∏∫Êï∞ÁªÑÔºå‰æø‰∫éÊéíÂ∫è
      const keywords = Object.entries(this.getTargetStats)
        .map(([word, count]) => ({
          word,
          count,
          size: this.getWordSize(count),
          color: this.getWordColor(count),
          rotate: Math.random() > 0.5 ? Math.random() * 30 : Math.random() * -30, // ÈöèÊú∫ÊóãËΩ¨ËßíÂ∫¶
          placed: false,
          width: 0, // Â∞ÜÂú®ÂêéÈù¢ËÆ°ÁÆó
          height: 0 // Â∞ÜÂú®ÂêéÈù¢ËÆ°ÁÆó
        }))
        .sort((a, b) => b.count - a.count); // ÊåâÊï∞ÈáèÈôçÂ∫èÊéíÂ∫è
      
      // ‰ªé‰∏≠ÂøÉÁÇπÂºÄÂßãÔºåËû∫ÊóãÂêëÂ§ñÊîæÁΩÆ
      let angle = 0;
      let radius = 0;
      const radiusIncrement = 10;
      const angleIncrement = 0.3;
      const maxAttempts = 100; // Èò≤Ê≠¢Êó†ÈôêÂæ™ÁéØ
      
      // ÂÅáËÆæÊØè‰∏™Â≠óÂ§ßÁ∫¶Âç†ÊçÆÁöÑrpxÂÆΩÂ∫¶
      const getWordDimensions = (word, fontSize) => {
        // Á≤óÁï•‰º∞ËÆ°Ôºö‰∏≠ÊñáÂ≠óÁ¨¶ÂÆΩÂ∫¶Á∫¶Á≠â‰∫éÂ≠ó‰ΩìÂ§ßÂ∞èÔºåËã±ÊñáÂ≠óÁ¨¶ÂÆΩÂ∫¶Á∫¶‰∏∫Â≠ó‰ΩìÂ§ßÂ∞èÁöÑ0.6ÂÄç
        let width = 0;
        for (let i = 0; i < word.length; i++) {
          const char = word.charAt(i);
          if (/[\u4e00-\u9fa5]/.test(char)) {
            width += fontSize; // ‰∏≠ÊñáÂ≠óÁ¨¶
          } else {
            width += fontSize * 0.6; // Ëã±ÊñáÂíåÂÖ∂‰ªñÂ≠óÁ¨¶
          }
        }
        return {
          width: width + 20, // Â¢ûÂä†‰∏Ä‰∫õÂÜÖËæπË∑ù
          height: fontSize + 20 // Â¢ûÂä†‰∏Ä‰∫õÂÜÖËæπË∑ù
        };
      };
      
      // Ê£ÄÊü•‰ΩçÁΩÆÊòØÂê¶ÂêàÊ≥ïÔºà‰∏ç‰∏éÂ∑≤ÊîæÁΩÆÁöÑËØçÈáçÂè†Ôºâ
      const isPositionValid = (x, y, width, height) => {
        // Ê£ÄÊü•ÊòØÂê¶Âú®ÂÆπÂô®ÂÜÖ
        if (x < 0 || x + width > containerWidth || y < 0 || y + height > containerHeight) {
          return false;
        }
        
        // Ê£ÄÊü•ÊòØÂê¶‰∏éÂÖ∂‰ªñËØçÈáçÂè†
        for (const keyword of this.processedKeywords) {
          const kx = keyword.x;
          const ky = keyword.y;
          const kw = keyword.width;
          const kh = keyword.height;
          
          // ÁÆÄÂçïÁöÑÁü©ÂΩ¢Á¢∞ÊíûÊ£ÄÊµã
          if (!(x > kx + kw || x + width < kx || y > ky + kh || y + height < ky)) {
            return false;
          }
        }
        
        return true;
      };
      
      // ÊåâÈ°∫Â∫èÊîæÁΩÆËØçËØ≠
      for (const keyword of keywords) {
        const { width, height } = getWordDimensions(keyword.word, keyword.size);
        keyword.width = width;
        keyword.height = height;
        
        // Â∞ùËØïÊâæÂà∞‰∏Ä‰∏™‰ΩçÁΩÆ
        let attempts = 0;
        let placed = false;
        
        // ÈáçË¶ÅÁöÑËØçÔºàÊï∞ÈáèÂ§öÁöÑÔºâÂ∞ùËØïÊîæÂú®‰∏≠ÂøÉ‰ΩçÁΩÆ
        if (keyword.count >= this.keywordMaxCount * 0.8) {
          const x = centerX - width / 2;
          const y = centerY - height / 2;
          if (isPositionValid(x, y, width, height)) {
            keyword.x = x;
            keyword.y = y;
            keyword.placed = true;
            this.processedKeywords.push(keyword);
            placed = true;
          }
        }
        
        if (!placed) {
          // Ëû∫ÊóãÊñπÂºèÂ∞ùËØïÊîæÁΩÆ
          while (attempts < maxAttempts && !placed) {
            angle += angleIncrement;
            radius += radiusIncrement / (Math.floor(angle / (2 * Math.PI)) + 1);
            
            const x = centerX + radius * Math.cos(angle) - width / 2;
            const y = centerY + radius * Math.sin(angle) - height / 2;
            
            if (isPositionValid(x, y, width, height)) {
              keyword.x = x;
              keyword.y = y;
              keyword.placed = true;
              this.processedKeywords.push(keyword);
              placed = true;
            }
            
            attempts++;
          }
        }
        
        // Â¶ÇÊûúÂ∞ùËØïÂ§öÊ¨°‰ªçÊó†Ê≥ïÊîæÁΩÆÔºåÂàôÂøΩÁï•Á¢∞ÊíûËßÑÂàô
        if (!placed && keyword.count > 1) {
          keyword.x = Math.random() * (containerWidth - width);
          keyword.y = Math.random() * (containerHeight - height);
          keyword.placed = true;
          this.processedKeywords.push(keyword);
        }
      }
    },
    
    // Ëé∑ÂèñËØç‰∫ë‰∏≠Â≠óÁöÑÂ§ßÂ∞è
    getWordSize(count) {
      const maxSize = 60; // ÊúÄÂ§ßÂ≠ó‰ΩìÂ§ßÂ∞è
      const minSize = 24; // ÊúÄÂ∞èÂ≠ó‰ΩìÂ§ßÂ∞è
      
      if (count === this.keywordMaxCount) {
        return maxSize;
      }
      
      // ‰ΩøÁî®ÂØπÊï∞Â∞∫Â∫¶‰ΩøÂ§ßÂ∞èÂ∑ÆÂºÇÊõ¥ÊòéÊòæ
      const ratio = Math.log(count + 1) / Math.log(this.keywordMaxCount + 1);
      return Math.max(minSize, Math.round(minSize + ratio * (maxSize - minSize)));
    },
    
    // Ëé∑ÂèñËØç‰∫ë‰∏≠Â≠óÁöÑÈ¢úËâ≤
    getWordColor(count) {
      const colorOptions = [
        '#FF6B6B', // Á∫¢Ëâ≤ - ÈáçË¶Å
        '#FFB86C', // Ê©ôËâ≤
        '#8BE9FD', // ËìùËâ≤
        '#BD93F9', // Á¥´Ëâ≤
        '#6272A4'  // ÁÅ∞ËìùËâ≤ - ‰∏çÈáçË¶Å
      ];
      
      // ËÆ°ÁÆóÈ¢úËâ≤Á¥¢ÂºïÔºå‰ΩøÁî®ÂØπÊï∞Â∞∫Â∫¶
      const maxIndex = colorOptions.length - 1;
      const ratio = Math.log(count + 1) / Math.log(this.keywordMaxCount + 1);
      const index = Math.floor((1 - ratio) * maxIndex);
      
      return colorOptions[Math.min(index, maxIndex)];
    },

    // ‰øÆÊîπ checkVisibility ÊñπÊ≥ï
    checkVisibility() {
      const query = uni.createSelectorQuery().in(this);
      query.select('.stats-container').boundingClientRect(data => {
        const isVisible = data && data.width > 0 && data.height > 0;
        console.log('ÂàÜÊûêÈ°µÈù¢ÂèØËßÅÊÄß:', isVisible);
        
        if (isVisible) {
          // Â¶ÇÊûúÁªÑ‰ª∂ÂèØËßÅÔºåÂàôÂàùÂßãÂåñÂπ∂Âä†ËΩΩÊï∞ÊçÆ
          if (!this._initialized) {
            this.initAnalysis();
          } else if (!this.periodStatsData && !this._requestLock) {
            // Â¶ÇÊûúÂ∑≤ÂàùÂßãÂåñ‰ΩÜÊ≤°ÊúâÊï∞ÊçÆ‰∏îÊú™ÈîÅÂÆöÔºåÂàôÂä†ËΩΩÊï∞ÊçÆ
            this.loadAllStatsWithLock();
          }
        }
      }).exec();
    },

    // ‰øÆÊîπËé∑ÂèñÁªüËÆ°Êï∞ÊçÆÁöÑÊñπÊ≥ï
    fetchStats() {
      this.loading = true
      this.statsData = null
      this.emotionTips = null // ÈáçÁΩÆÊèêÁ§∫Êï∞ÊçÆ
      
      getPeriodEmotionStats(this.currentPeriod, (res) => {
        console.log('Ëé∑ÂèñÁªüËÆ°Êï∞ÊçÆÊàêÂäü:', res)
        this.statsData = res
        this.loading = false
        
        // Â¶ÇÊûúËøîÂõû‰∫Ütask_idÔºåÂàôËé∑ÂèñÊÉÖÊÑüÂª∫ËÆÆ
        if (res.data && res.data.task_id) {
          this.tipTaskId = res.data.task_id
          this.tipRetryCount = 0
          this.fetchEmotionTips()
        }
      }, (error) => {
        console.error('Ëé∑ÂèñÁªüËÆ°Êï∞ÊçÆÂ§±Ë¥•:', error)
        this.loading = false
        uni.showToast({
          title: 'Ëé∑ÂèñÁªüËÆ°Êï∞ÊçÆÂ§±Ë¥•',
          icon: 'none'
        })
      })
    },
    
    // Êñ∞Â¢ûËé∑ÂèñÊÉÖÊÑüÂª∫ËÆÆÁöÑÊñπÊ≥ï
    fetchEmotionTips() {
      if (!this.tipTaskId || this.tipRetryCount >= this.tipMaxRetries) {
        return
      }
      
      getEmotionTips(this.tipTaskId, (res) => {
        console.log('Ëé∑ÂèñÊÉÖÊÑüÂª∫ËÆÆÊàêÂäü:', res)
        
        // Â§ÑÁêÜÊàêÂäüÂìçÂ∫î
        if (res.data && res.data.tips) {
          this.emotionTips = res.data.tips
        }
      }, (error) => {
        console.log('Ëé∑ÂèñÊÉÖÊÑüÂª∫ËÆÆÂ§±Ë¥•ÊàñÂ§ÑÁêÜ‰∏≠:', error)
        
        // Â¶ÇÊûúÊòØÂ§ÑÁêÜ‰∏≠Áä∂ÊÄÅÔºåÂàôÂª∂ËøüÈáçËØï
        if (error.message && error.message.includes('Â§ÑÁêÜ‰∏≠')) {
          this.tipRetryCount++
          if (this.tipRetryCount < this.tipMaxRetries) {
            setTimeout(() => {
              this.fetchEmotionTips()
            }, 3000)
          }
        }
      })
    },

    // Ê∑ªÂä†ÂØºËà™ÊñπÊ≥ï
    navigateToEmotion() {
      uni.switchTab({
        url: '/pages/tabbar/emotion/home'
      });
    },
  },

  watch: {
    // timeSeriesData: {
    //   handler() {
    //     this.$nextTick(() => {
    //       this.updateCharts()
    //     })
    //   },
    //   deep: true
    // },
    periodStatsData: {
      handler(newVal) {
        if (!newVal) return
        
        this.$nextTick(() => {
          // ÊâπÈáèÂ§ÑÁêÜÊâÄÊúâ‰æùËµñ‰∫éperiodStatsDataÁöÑÊõ¥Êñ∞
          this.updateCharts()
          if (newVal?.statistics?.emotion) {
            this.updateBubbles()
          }
        })
      },
      deep: true
    },
    
    // ÁõëÂê¨ÂÆπÂô®Â∞∫ÂØ∏ÂèòÂåñ
    containerWidth(newVal) {
      if (newVal > 0 && this.bubbleChart) {
        this.bubbleChart.options.width = newVal;
        this.bubbleChart.options.height = this.containerHeight;
        this.updateBubbles();
      }
    },

    // Ê∑ªÂä†Ë∑ØÁî±ÂèòÂåñÁõëÂê¨
    '$route.query.period'(newPeriod) {
      if (newPeriod && this.periods.includes(newPeriod)) {
        this.changePeriod(newPeriod);
      }
    },

    // ‰ºòÂåñcurrentPeriodÁõëÂê¨Âô®
    currentPeriod: {
      immediate: false, // Êîπ‰∏∫falseÔºåÈÅøÂÖçÁªÑ‰ª∂ÂàõÂª∫Êó∂Â∞±Ëß¶Âèë
      handler(newVal, oldVal) {
        if (newVal !== oldVal) { // Âè™Âú®ÁúüÊ≠£ÂèòÂåñÊó∂Ëß¶Âèë
          this.loadAllStats()
        }
      }
    }
  },

  onReady() {
    console.log('ÁªÑ‰ª∂Â∑≤Â∞±Áª™')
  },

  beforeDestroy() {
    this.stopAnimation()
    clearInterval(this.autoRefreshTimer)
  }
}
</script>

<style lang="scss" scoped>
.stats-container {
  min-height: 100vh;
  background-color: #0A0B1B;
  padding: 30rpx;
}

.period-selector {
  display: flex;
  justify-content: center;
  margin-bottom: 40rpx;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 16rpx;
  padding: 8rpx;
  
  .period-item {
    flex: 1;
    text-align: center;
    padding: 16rpx 0;
    color: rgba(255, 255, 255, 0.6);
    font-size: 28rpx;
    border-radius: 12rpx;
    max-width: 160rpx;
    
    &.active {
      background: #7C4DFF;
      color: #ffffff;
    }
  }
}

.section-title {
  display: block;
  color: rgba(255, 255, 255, 0.9);
  font-size: 32rpx;
  font-weight: 500;
  margin: 40rpx 0 20rpx;
  padding-left: 20rpx;
  position: relative;
  
  &::before {
    content: '';
    position: absolute;
    left: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 6rpx;
    height: 24rpx;
    background: #7C4DFF;
    border-radius: 3rpx;
  }
}

.stats-card {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 20rpx;
  padding: 30rpx;
  margin-bottom: 30rpx;
}

.overview-stats {
  display: flex;
  justify-content: space-between;
  margin-bottom: 40rpx;
  
  .stat-item {
    text-align: center;
    background: rgba(255, 255, 255, 0.1);
    padding: 20rpx;
    border-radius: 16rpx;
    flex: 1;
    margin: 0 10rpx;
    
    .stat-value {
      display: block;
      color: #7C4DFF;
      font-size: 36rpx;
      font-weight: 600;
    }
    
    .stat-label {
      color: rgba(255, 255, 255, 0.6);
      font-size: 24rpx;
    }
  }
}

.chart-wrapper {
  width: 100%;
  padding: 20rpx;
  box-sizing: border-box;
  position: relative;
  overflow: hidden; /* Èò≤Ê≠¢ÂÜÖÂÆπÊ∫¢Âá∫ */
}

.chart-title {
  font-size: 28rpx;
  color: rgba(255, 255, 255, 0.9);
  margin-bottom: 30rpx;
  text-align: center;
}

.chart-section {
  margin: 30rpx 0;
}

.emotion-bubbles-wrapper {
  margin: 20rpx 0;
  width: 100%;
  height: 450rpx;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 16rpx;
  padding: 20rpx;
  overflow: hidden;
}

.emotion-bubbles {
  position: relative;
  width: 100%;
  height: 100%;
}

.bubbles-container {
  position: relative;
  width: 100%;
  height: 100%;
}

.bubble-item {
  position: absolute;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  box-shadow: inset 0 0 15rpx rgba(255, 255, 255, 0.2);
  backdrop-filter: blur(5px);
  border-radius: 50%;
  overflow: hidden;
  
  &::after {
    content: '';
    position: absolute;
    top: -10%;
    left: -10%;
    width: 120%;
    height: 120%;
    background: linear-gradient(
      120deg,
      rgba(255, 255, 255, 0) 30%,
      rgba(255, 255, 255, 0.3) 50%,
      rgba(255, 255, 255, 0) 70%
    );
    transform: rotate(30deg);
  }
}

.bubble-content {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  width: 100%;
  height: 100%;
  z-index: 1;
}

.emotion-face {
  font-size: 36rpx;
  margin-bottom: 8rpx;
}

.emotion-text {
  font-size: 24rpx;
  padding: 4rpx 12rpx;
  border-radius: 20rpx;
}

.debug-info {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  color: rgba(255, 255, 255, 0.5);
  font-size: 28rpx;
}

.chart-tip {
  display: flex;
  align-items: flex-start;
  padding: 16rpx 20rpx;
  background: rgba(255, 255, 255, 0.08);
  border-radius: 12rpx;
  margin-top: 20rpx;
  border-left: 6rpx solid rgba(255, 255, 255, 0.2);
  box-shadow: 0 4rpx 12rpx rgba(0, 0, 0, 0.1);
  
  .tip-icon {
    font-size: 32rpx;
    margin-right: 12rpx;
    flex-shrink: 0;
  }
  
  .tip-text {
    color: rgba(255, 255, 255, 0.8);
    font-size: 24rpx;
    line-height: 1.5;
    flex: 1;
  }
}

// Á°Æ‰øùcanvasÂú®‰∏çÂêåÂπ≥Âè∞‰∏ãÈÉΩËÉΩÊ≠£Á°ÆÊòæÁ§∫
:deep(canvas) {
  width: 100%;
  height: 100%;
}

// ÂàÜÁ±ªÁªüËÆ°ÂõæË°®Ê†∑Âºè
.category-chart {
  display: flex;
  justify-content: space-around;
  align-items: flex-start;
  height: 280rpx; // ÂáèÂ∞èÊï¥‰ΩìÈ´òÂ∫¶
  width: 100%;
  padding: 40rpx 0 20rpx 0; // Â¢ûÂä†È°∂ÈÉ®ÂÜÖËæπË∑ùÔºå‰∏∫Êï∞ÂÄºÊ†áÁ≠æÁïôÂá∫Á©∫Èó¥
  box-sizing: border-box;
  overflow-x: auto;
}

.category-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  height: 100%;
  min-width: 100rpx;
  margin: 0 10rpx;
}

.category-name {
  color: rgba(255, 255, 255, 0.8);
  font-size: 24rpx;
  font-weight: 500;
  margin-top: 15rpx;
  text-align: center;
  width: 100%;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.category-bars {
  display: flex;
  align-items: flex-end;
  justify-content: center;
  height: 180rpx; // ÂáèÂ∞èÈ´òÂ∫¶
  width: 100%;
}

.emotion-bar {
  width: 30rpx;
  margin: 0 4rpx;
  border-radius: 6rpx 6rpx 0 0;
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: center;
  min-height: 20rpx;
  box-shadow: 0 2rpx 4rpx rgba(0, 0, 0, 0.1);
  
  &.positive {
    background: linear-gradient(to top, #4CAF50, #81C784);
  }
  
  &.neutral {
    background: linear-gradient(to top, #42A5F5, #90CAF9);
  }
  
  &.negative {
    background: linear-gradient(to top, #FF5252, #FF8A80);
  }
  
  .bar-value {
    position: absolute;
    top: -24rpx; // Â¢ûÂä†‰∏éÊü±Áä∂ÂõæÁöÑË∑ùÁ¶ª
    font-size: 20rpx;
    color: rgba(255, 255, 255, 0.8);
    background: rgba(0, 0, 0, 0.5); // Â¢ûÂä†ËÉåÊôØ‰∏çÈÄèÊòéÂ∫¶
    padding: 2rpx 8rpx;
    border-radius: 10rpx;
    z-index: 2; // Á°Æ‰øùÊòæÁ§∫Âú®ÊúÄ‰∏äÂ±Ç
  }
}

// ‰øÆÊîπÂêéÁöÑËØç‰∫ëÊ†∑Âºè
.keyword-cloud-container {
  height: 400rpx;
  width: 100%;
  position: relative;
}

.keyword-cloud {
  width: 100%;
  height: 100%;
  position: relative;
}

.keyword-tag {
  position: absolute;
  padding: 10rpx 16rpx;
  background-color: rgba(255, 255, 255, 0.08);
  border-radius: 30rpx;
  white-space: nowrap;
  text-align: center;
  font-weight: 500;
  box-shadow: 0 2rpx 8rpx rgba(0, 0, 0, 0.2);
}

.empty-chart {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 200rpx;
  width: 100%;
  color: rgba(255, 255, 255, 0.5);
  font-size: 26rpx;
}

// Ê∑ªÂä†Âõæ‰æãÊ†∑Âºè
.chart-legend {
  display: flex;
  justify-content: center;
  margin-top: 10rpx;
  padding: 10rpx 0;
  width: 100%;
  box-sizing: border-box;
}

.legend-item {
  display: flex;
  align-items: center;
  margin: 0 15rpx;
}

.legend-color {
  width: 20rpx;
  height: 20rpx;
  border-radius: 4rpx;
  margin-right: 6rpx;
  
  &.positive {
    background: linear-gradient(to top, #4CAF50, #81C784);
  }
  
  &.neutral {
    background: linear-gradient(to top, #42A5F5, #90CAF9);
  }
  
  &.negative {
    background: linear-gradient(to top, #FF5252, #FF8A80);
  }
}

.legend-text {
  font-size: 22rpx;
  color: rgba(255, 255, 255, 0.7);
}

// Ê∑ªÂä†Á©∫Áä∂ÊÄÅÊ†∑ÂºèÔºå‰∏é history.vue ‰øùÊåÅ‰∏ÄËá¥
.empty-state {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 100vh;
  padding: 0 40rpx;
  background: linear-gradient(180deg, #0A0B1B 0%, #0A0B1B 100%);
  
  .empty-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    transform: translateY(-10%);
    
    .main-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 60rpx;
      
      .empty-text {
        font-size: 36rpx;
        color: rgba(255, 255, 255, 0.8);
        margin-bottom: 20rpx;
        letter-spacing: 4rpx;
        font-weight: 300;
        text-shadow: 0 2rpx 4rpx rgba(0, 0, 0, 0.1);
        
        .highlight {
          color: #7C4DFF;
          font-weight: 500;
          background: linear-gradient(135deg, #7C4DFF, #8B5CF6);
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
        }
        
        .brand-text {
          font-weight: 500;
          background: linear-gradient(135deg, #6366f1, #8b5cf6);
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          padding: 0 4rpx;
        }
      }
    }
    
    .encouragement {
      margin-bottom: 80rpx;
      text-align: center;
      
      .tip {
        font-size: 28rpx;
        color: rgba(255, 255, 255, 0.5);
        font-style: italic;
        line-height: 1.5;
        padding: 20rpx 40rpx;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 30rpx;
        backdrop-filter: blur(10px);
      }
    }
    
    .goto-emotion-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      color: #ffffff;
      border: none;
      padding: 20rpx 60rpx;
      border-radius: 40rpx;
      font-size: 28rpx;
      box-shadow: 0 4rpx 12rpx rgba(99, 102, 241, 0.2);
      
      .iconfont {
        font-size: 28rpx;
        margin-right: 10rpx;
      }
      
      &:active {
        transform: scale(0.98);
      }
    }
  }
}

// Ê∑ªÂä†ÁÆÄÂçïÁöÑÊ∏êÂÖ•Âä®Áîª
.empty-content {
  animation: fadeIn 0.8s ease-out;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(-5%);
  }
  to {
    opacity: 1;
    transform: translateY(-10%);
  }
}
</style>
